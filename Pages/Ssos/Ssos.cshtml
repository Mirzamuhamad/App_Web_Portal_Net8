@page
@model TestLandingPageNet8.Pages.Ssos.SsosModel
@{
    Layout = null;
    ViewData["Title"] = "Layanan Darurat (SOS)";
}

<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />

    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { primary: "#ef4444", dark: "#0f172a" } // Merah untuk nuansa SOS/Darurat
                }
            }
        };
    </script>

    <style>
        body {
            font-family: 'Mulish', sans-serif;
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 1rem;
        }

        .tap-highlight-none {
            -webkit-tap-highlight-color: transparent;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ef4444;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @@keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stat-card.active {
            border-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
            transform: translateY(-2px);
        }
    </style>
</head>

<body class="bg-slate-50 dark:bg-dark text-slate-900 dark:text-slate-100 min-h-screen pb-10">

    <div id="global-loader"
        class="hidden fixed inset-0 z-[9999] bg-white/60 dark:bg-dark/60 backdrop-blur-sm flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <span class="text-sm font-bold animate-pulse">Mencari Layanan Terdekat...</span>
    </div>

    <nav
        class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md sticky top-0 z-[1000] border-b border-slate-200 dark:border-slate-800">
        <div class="mx-auto px-2 sm:px-4 h-16 flex items-center justify-between">
            <a asp-page="/index" class="flex items-center gap-3">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white">
                    <span class="material-icons-outlined text-sm">arrow_back</span>
                </div>
                <span class="text-sm sm:text-lg font-bold text-slate-700 dark:text-slate-100">Layanan Darurat</span>
            </a>
            <button onclick="fetchData()"
                class="flex items-center gap-2 px-3 py-2 rounded-xl bg-primary/10 text-primary active:scale-95 transition-all">
                <span class="material-icons-outlined text-sm">my_location</span>
                <span class="text-xs font-bold uppercase tracking-tight">Cek Lokasi</span>
            </button>
        </div>
    </nav>

    <main class="mx-auto px-4 pt-4 space-y-4">

        <div class="relative space-y-3">
            <div
                class="flex items-center gap-2 bg-white dark:bg-slate-900 p-2 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800">
                <div class="relative flex-1">
                    <span
                        class="absolute left-3 top-1/2 -translate-y-1/2 material-icons-outlined text-slate-400 text-lg">search</span>
                    <input type="text" id="search-text" oninput="handleSearch()" placeholder="Cari RS atau Polisi..."
                        class="w-full pl-10 pr-4 py-2 bg-transparent border-none text-sm font-semibold focus:ring-0 focus:outline-none placeholder:text-slate-400" />
                </div>

                <div class="h-6 w-[1px] bg-slate-200 dark:bg-slate-700"></div>

                <div class="flex items-center gap-1 px-2">
                    <input type="number" id="input-radius" value="5"
                        class="w-8 bg-transparent border-none text-sm font-bold text-primary focus:ring-0 focus:outline-none p-0 text-center" />
                    <span class="text-[10px] font-bold text-slate-400">KM</span>
                </div>

                <button onclick="fetchData()"
                    class="w-10 h-10 flex items-center justify-center rounded-xl bg-primary text-white shadow-lg shadow-primary/30 active:scale-90 transition-transform">
                    <span class="material-icons-outlined text-lg">near_me</span>
                </button>
            </div>

            <div class="flex justify-between items-center px-2">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Radius pencarian: <span
                        class="text-primary" id="active-radius">5</span> KM</span>
                <button onclick="resetFilter()"
                    class="text-[10px] font-bold text-slate-400 hover:text-primary transition-colors uppercase tracking-widest">Reset</button>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
            <div id="card-hospital" onclick="filterData('Hospital', this)"
                class="stat-card tap-highlight-none bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 p-3 rounded-2xl text-center transition-all cursor-pointer">
                <span class="material-icons-outlined text-red-500 block mb-1">local_hospital</span>
                <span id="count-hospital" class="text-sm font-black block">0</span>
                <span class="text-[9px] text-slate-400 font-bold uppercase">Medis</span>
            </div>
            <div id="card-fire" onclick="filterData('Fire', this)"
                class="stat-card tap-highlight-none bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 p-3 rounded-2xl text-center transition-all cursor-pointer">
                <span class="material-icons-outlined text-orange-500 block mb-1">fire_truck</span>
                <span id="count-fire" class="text-sm font-black block">0</span>
                <span class="text-[9px] text-slate-400 font-bold uppercase">Damkar</span>
            </div>
            <div id="card-police" onclick="filterData('Police', this)"
                class="stat-card tap-highlight-none bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 p-3 rounded-2xl text-center transition-all cursor-pointer">
                <span class="material-icons-outlined text-blue-600 block mb-1">local_police</span>
                <span id="count-police" class="text-sm font-black block">0</span>
                <span class="text-[9px] text-slate-400 font-bold uppercase">Polisi</span>
            </div>
        </div>

        <div
            class="h-48 bg-slate-200 dark:bg-slate-800 rounded-3xl overflow-hidden relative border-4 border-white dark:border-slate-900 shadow-sm">
            <div id="map"></div>
        </div>

        <div class="space-y-4">
            <div class="flex items-center justify-between px-2">
                <h3 id="list-title" class="text-sm font-bold text-slate-700 dark:text-slate-300">Semua Layanan Terdekat
                </h3>
            </div>

            <div id="sos-container" class="space-y-3 pb-20"></div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-6.2088, 106.8456], 13);
        let markersLayer = L.layerGroup().addTo(map);
        let allData = [];
        let userCoords = { lat: 0, lon: 0 };

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        function showLoading(show) {
            document.getElementById('global-loader').classList.toggle('hidden', !show);
        }

        function fetchData() {
            showLoading(true);
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updateLocation, (err) => {
                    showLoading(false);
                    alert("Izin lokasi diperlukan untuk mencari layanan darurat terdekat.");
                }, { enableHighAccuracy: true });
            }
        }

        async function updateLocation(position) {
            userCoords.lat = position.coords.latitude;
            userCoords.lon = position.coords.longitude;

            let radiusKm = document.getElementById('input-radius').value || 5;
            document.getElementById('active-radius').innerText = radiusKm;
            const radiusMeters = radiusKm * 1000;

            map.setView([userCoords.lat, userCoords.lon], 14);
            markersLayer.clearLayers();

            // User Marker
            L.marker([userCoords.lat, userCoords.lon], {
                icon: L.divIcon({ html: `<div class="w-4 h-4 bg-primary border-2 border-white rounded-full shadow-lg pulse"></div>` })
            }).addTo(markersLayer);

            const query = `[out:json];(
            node["amenity"="hospital"](around:${radiusMeters},${userCoords.lat},${userCoords.lon});
            way["amenity"="hospital"](around:${radiusMeters},${userCoords.lat},${userCoords.lon});
            node["amenity"="fire_station"](around:${radiusMeters},${userCoords.lat},${userCoords.lon});
            node["amenity"="police"](around:${radiusMeters},${userCoords.lat},${userCoords.lon});
        );out center;`;

            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const json = await res.json();

                allData = json.elements.map(item => {
                    let type = 'Hospital';
                    if (item.tags.amenity === 'fire_station') type = 'Fire';
                    if (item.tags.amenity === 'police') type = 'Police';

                    const lat = item.lat || item.center.lat;
                    const lon = item.lon || item.center.lon;
                    const dist = calculateDistance(userCoords.lat, userCoords.lon, lat, lon);

                    return {
                        ...item,
                        type,
                        dist,
                        lat, lon,
                        name: item.tags.name || (type === 'Hospital' ? "RS Tanpa Nama" : (type === 'Police' ? "Kantor Polisi" : "Pemadam Kebakaran")),
                        phone: item.tags.phone || item.tags["contact:phone"] || "N/A",
                        address: item.tags["addr:street"] || "Alamat tidak tersedia"
                    };
                }).sort((a, b) => a.dist - b.dist);

                updateStats();
                handleSearch();
            } catch (e) {
                alert("Gagal memuat data dari satelit.");
            } finally {
                showLoading(false);
            }
        }

        function handleSearch() {
            const searchText = document.getElementById('search-text').value.toLowerCase();
            const filtered = allData.filter(item => item.name.toLowerCase().includes(searchText));
            renderList(filtered);
        }

        function filterData(type, el) {
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            const filtered = allData.filter(item => item.type === type);
            document.getElementById('list-title').innerText = "Daftar " + (type === 'Hospital' ? 'Rumah Sakit' : type === 'Fire' ? 'Pemadam Kebakaran' : 'Kantor Polisi');
            renderList(filtered);
        }

        @* function renderList(dataToRender) {
            const container = document.getElementById('sos-container');
            let html = '';

            // Bersihkan marker lama sebelum render baru
            markersLayer.clearLayers();

            dataToRender.forEach(item => {
                const color = item.type === 'Hospital' ? 'red' : (item.type === 'Fire' ? 'orange' : 'blue');
                const icon = item.type === 'Hospital' ? 'local_hospital' : (item.type === 'Fire' ? 'fire_truck' : 'local_police');

                // Validasi data: anggap kosong jika nilainya null, undefined, atau string kosong/placeholder
                const hasAddress = item.address && item.address !== "Alamat tidak tersedia";
                const hasPhone = item.phone && item.phone !== "N/A" && item.phone !== "";

                html += `
            <div class="bg-white dark:bg-slate-900 p-4 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm transition-all">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-${color}-500/10 text-${color}-600 flex items-center justify-center">
                            <span class="material-icons-outlined">${icon}</span>
                        </div>
                        <div>
                            <h4 class="font-extrabold text-sm text-slate-800 dark:text-slate-100">${item.name}</h4>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">${item.dist.toFixed(2)} KM dari lokasi Anda</p>
                        </div>
                    </div>
                </div>

                <div class="pl-13 space-y-2">
                    ${hasAddress ? `
                    <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
                        <span class="material-icons-outlined text-xs">location_on</span>
                        <span class="text-[11px] font-medium line-clamp-1">${item.address}</span>
                    </div>` : ''}

                    ${hasPhone ? `
                    <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
                        <span class="material-icons-outlined text-xs">phone</span>
                        <span class="text-[11px] font-bold text-slate-700 dark:text-slate-200">${item.phone}</span>
                    </div>` : ''}
                </div>

                <div class="mt-4 grid ${hasPhone ? 'grid-cols-2' : 'grid-cols-1'} gap-2">
                    ${hasPhone ? `
                    <a href="tel:${item.phone}" class="flex items-center justify-center gap-2 py-2 bg-green-500 text-white rounded-xl text-[10px] font-black uppercase">
                        <span class="material-icons-outlined text-sm">call</span> Hubungi
                    </a>` : ''}
                    
                    <button onclick="openGoogleMaps(${item.lat}, ${item.lon})" class="flex items-center justify-center gap-2 py-2 bg-primary text-white rounded-xl text-[10px] font-black uppercase">
                        <span class="material-icons-outlined text-sm">directions</span> Navigasi
                    </button>
                </div>
            </div>`;

                // Tambahkan marker ke peta
                const popupContent = `<b>${item.name}</b>${hasPhone ? '<br>' + item.phone : ''}`;
                L.marker([item.lat, item.lon]).addTo(markersLayer).bindPopup(popupContent);
            });

            container.innerHTML = html || '<p class="text-center py-10 text-slate-400 text-xs font-medium">Data tidak ditemukan.</p>';
        } *@


            function renderList(dataToRender) {
    const container = document.getElementById('sos-container');
    let html = '';
    
    markersLayer.clearLayers();

    dataToRender.forEach(item => {
        const color = item.type === 'Hospital' ? 'red' : (item.type === 'Fire' ? 'orange' : 'blue');
        const icon = item.type === 'Hospital' ? 'local_hospital' : (item.type === 'Fire' ? 'fire_truck' : 'local_police');

        // LOGIKA TELEPON: Fallback hanya untuk Damkar (113) dan Polisi (110)
        let finalPhone = item.phone && item.phone !== "N/A" ? item.phone : "";
        
        if (!finalPhone || finalPhone === "") {
            if (item.type === 'Fire') {
                finalPhone = "113";
            } else if (item.type === 'Police') {
                finalPhone = "110";
            }
        }
        
        // Cek apakah alamat tersedia
        const hasAddress = item.address && item.address !== "Alamat tidak tersedia" && item.address.trim() !== "";

        html += `
            <div class="bg-white dark:bg-slate-900 p-4 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm transition-all">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-${color}-500/10 text-${color}-600 flex items-center justify-center">
                            <span class="material-icons-outlined">${icon}</span>
                        </div>
                        <div>
                            <h4 class="font-extrabold text-sm text-slate-800 dark:text-slate-100">${item.name}</h4>
                            <p class="text-[10px] font-bold text-slate-400 uppercase">${item.dist.toFixed(2)} KM dari lokasi Anda</p>
                        </div>
                    </div>
                </div>

                <div class="pl-13 space-y-2">
                    ${hasAddress ? `
                    <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
                        <span class="material-icons-outlined text-xs">location_on</span>
                        <span class="text-[11px] font-medium line-clamp-1">${item.address}</span>
                    </div>` : ''}

                    ${finalPhone ? `
                    <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400">
                        <span class="material-icons-outlined text-xs">phone</span>
                        <span class="text-[11px] font-bold text-slate-700 dark:text-slate-200">${finalPhone}</span>
                    </div>` : ''}
                </div>

                <div class="mt-4 grid ${finalPhone ? 'grid-cols-2' : 'grid-cols-1'} gap-2">
                    ${finalPhone ? `
                    <a href="tel:${finalPhone}" class="flex items-center justify-center gap-2 py-2 bg-green-500 text-white rounded-xl text-[10px] font-black uppercase transition-transform active:scale-95">
                        <span class="material-icons-outlined text-sm">call</span> Hubungi
                    </a>` : ''}
                    
                    <button onclick="openGoogleMaps(${item.lat}, ${item.lon})" class="flex items-center justify-center gap-2 py-2 bg-primary text-white rounded-xl text-[10px] font-black uppercase transition-transform active:scale-95">
                        <span class="material-icons-outlined text-sm">directions</span> Navigasi
                    </button>
                </div>
            </div>`;
        
        L.marker([item.lat, item.lon]).addTo(markersLayer).bindPopup(`<b>${item.name}</b>${finalPhone ? '<br>'+finalPhone : ''}`);
    });
    
    container.innerHTML = html || '<p class="text-center py-10 text-slate-400 text-xs font-medium">Layanan tidak ditemukan.</p>';
}

        function updateStats() {
            document.getElementById('count-hospital').innerText = allData.filter(x => x.type === 'Hospital').length;
            document.getElementById('count-fire').innerText = allData.filter(x => x.type === 'Fire').length;
            document.getElementById('count-police').innerText = allData.filter(x => x.type === 'Police').length;
        }

        function resetFilter() {
            document.getElementById('search-text').value = '';
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            document.getElementById('list-title').innerText = "Semua Layanan Terdekat";
            renderList(allData);
        }

        function openGoogleMaps(lat, lon) {
            window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`, '_blank');
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        window.onload = fetchData;
    </script>

</body>

</html>